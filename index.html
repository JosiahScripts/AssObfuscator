<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>REO Lua Obfuscator</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    textarea { width: 100%; height: 200px; margin-bottom: 10px; font-family: monospace; }
    button { padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <h1>REO Lua Obfuscator</h1>
  <textarea id="inputLua" placeholder="Paste your Lua code here…"></textarea><br>
  <button id="obfuscateBtn">Obfuscate &amp; Download</button>
  <textarea id="outputLua" readonly placeholder="Obfuscated Lua will appear here…"></textarea>

  <script>
    // Random identifier generator
    function randName(len) {
      len = len || Math.floor(Math.random() * 5) + 5;
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
      const chars   = letters + '0123456789_';
      let name = letters.charAt(Math.floor(Math.random() * letters.length));
      for (let i = 1; i < len; i++) {
        name += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return name;
    }

    function obfuscateLua() {
      const input = document.getElementById('inputLua').value;
      if (!input) { alert('Please paste some Lua code first.'); return; }

      // 1) Generate XOR key
      const keyChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let key = '';
      const keyLen = Math.floor(Math.random() * 5) + 5;
      for (let i = 0; i < keyLen; i++) {
        key += keyChars.charAt(Math.floor(Math.random() * keyChars.length));
      }

      // 2) XOR‐encrypt the Lua source
      let xorArr = [];
      for (let i = 0; i < input.length; i++) {
        xorArr.push(String.fromCharCode(input.charCodeAt(i) ^ key.charCodeAt(i % key.length)));
      }

      // 3) Base64‐encode the XOR result
      const b64 = btoa(xorArr.join(''));

      // 4) Compute checksums for anti‐tamper
      let sumB64 = 0, sumOrig = 0;
      for (let i = 0; i < b64.length; i++) {
        sumB64 = (sumB64 + b64.charCodeAt(i)) % 65536;
      }
      for (let i = 0; i < input.length; i++) {
        sumOrig = (sumOrig + input.charCodeAt(i)) % 65536;
      }

      // 5) Generate random names for Lua variables/functions
      const varB64   = randName();
      const varKey   = randName();
      const varAlpha = randName();
      const funcDec  = randName();
      const funcXor  = randName();
      const bufVar   = randName();
      const loadVar  = randName();

      // 6) Build the Lua stub (with proper '=' handling and credit newline)
      let stub = '--[[ PROTECTED BY REO ]]--\n'
        + 'local ' + varB64   + '="' + b64   + '";'
        + 'local ' + varKey   + '="' + key   + '";'
        + 'local ' + varAlpha + '="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";'
        + 'local function ' + funcDec + '(t)local r={}local i=1;'
        + 'while i<=#t do '
        +   'local c1=t:sub(i,i) local c2=t:sub(i+1,i+1);'
        +   'local c3=t:sub(i+2,i+2) local c4=t:sub(i+3,i+3);'
        +   'local a=' + varAlpha + ':find(c1,1,true)-1;'
        +   'local b=' + varAlpha + ':find(c2,1,true)-1;'
        +   'local c=(c3=="=") and 0 or ' + varAlpha + ':find(c3,1,true)-1;'
        +   'local d=(c4=="=") and 0 or ' + varAlpha + ':find(c4,1,true)-1;'
        +   'local n=a*2^18 + b*2^12 + c*2^6 + d;'
        +   'local x=math.floor(n/2^16)%256;'
        +   'local y=math.floor(n/2^8)%256;'
        +   'local z=n%256;'
        +   'r[#r+1]=string.char(x);'
        +   'if c3~="=" then r[#r+1]=string.char(y) end;'
        +   'if c4~="=" then r[#r+1]=string.char(z) end;'
        +   'i=i+4;'
        + 'end;'
        + 'return table.concat(r)end;'
        + 'local function ' + funcXor + '(a,b)local r=0;for k=0,7 do '
        +   'local A=a%2 local B=b%2;'
        +   'if A~=B then r=r+2^k end;'
        +   'a=math.floor(a/2) b=math.floor(b/2);'
        + 'end;return r end;'
        + 'local sum=0;for i=1,#' + varB64 + 'do sum=(sum+' + varB64 + ':byte(i))%65536 end;'
        + 'if sum~=' + sumB64 + ' then return end;'
        + 'local tmp=' + funcDec + '(' + varB64 + ');'
        + 'local ' + bufVar + '={};'
        + 'for i=1,#tmp do '
        +   bufVar + '[#' + bufVar + '+1]=string.char(' + funcXor
        +   '(tmp:byte(i),' + varKey + ':byte((i-1)%#' + varKey + '+1)));'
        + 'end;'
        + 'local script=table.concat(' + bufVar + ');'
        + 'local sum2=0;for i=1,#script do sum2=(sum2+script:byte(i))%65536 end;'
        + 'if sum2~=' + sumOrig + ' then return end;'
        + 'local ' + loadVar + '=(loadstring or load);' 
        + loadVar + '(script)();';

      // (Optional) — you can prepend ~40KB of junk here before `stub`

      // 7) Output & trigger download
      document.getElementById('outputLua').value = stub;
      const blob = new Blob([stub], { type: 'text/plain' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = 'obfuscated.lua';
      a.click();
      URL.revokeObjectURL(url);
    }

    document.getElementById('obfuscateBtn').addEventListener('click', obfuscateLua);
  </script>
</body>
</html>
